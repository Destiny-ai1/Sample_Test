<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="/style/main.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="/script/input.js"></script>
<title>Insert title here</title>
<style>
	/* ëŒ“ê¸€ ì‘ì„± ì°½ í¬ê¸° ë³€ê²½ ë§‰ê¸°*/
	textarea {
		resize: none; 
	}
</style>
</head>
<body>
	<div id="app">
		<header th:replace="~{/fragment/header.html}"> </header>
		<nav th:replace="~{/fragment/nav.html}"></nav>
		<main>
			<aside th:replace="~{/fragment/aside.html}"></aside>
			<section>
				<div class="mb-4">
                    <h2 th:text="${result.title}">ì œëª©:</h2> 
                    <div class="d-flex justify-content-between">
                        <p>
                            <strong>ì‘ì„±ì:</strong> <span th:text="${result.writer}"></span>
                        </p>
                        <p>
                            <strong>ì¡°íšŒìˆ˜:</strong> <span th:text="${result.readCnt}"></span> 
                            <strong>ì‘ì„±ì¼:</strong> <span th:text="${result.writeTime}"></span>
                        </p>
                    </div>
                </div>
                <div class="mb-4">
                    <h3>ë‚´ìš©:</h3>
                    <div th:utext="${result.content}"></div> 
                </div>
                
				<!-- ì¢‹ì•„ìš” ë‚˜ë¹ ìš” -->
				<div class="mb-4">
                    <button class="btn btn-outline-primary" id="like-btn">ì¢‹ì•„ìš” â™¡ 
                    <span id="goodCnt" th:text="${result.goodCnt}">0</span>
                    </button>
                    <button class="btn btn-outline-danger" id="dislike-btn">ë‚˜ë¹ ìš” ğŸ‘ 
                    <span id="badCnt" th:text="${result.badCnt}">0</span>
                    </button>
                </div>
                
				<!-- ëŒ“ê¸€ì‘ì„± -->
				<div sec:authorize="isAuthenticated()">
				<textarea class="form-control" rows="5" placeholder="ëŒ“ê¸€ì„ ë‹¬ì•„ì£¼ì„¸ìš”" id="comment"></textarea>
				<button class="btn btn-outline-success" id="write-comment">ëŒ“ê¸€ ì‘ì„±</button>
				</div>
				
				<!-- ëŒ“ê¸€ì‚­ì œ -->
				<div id="comments">
	    			<div th:each="comment:${result.comments}">
	    				<div class='upper' style="display:flex; justify-content: space-between;">
	    					<div>
	    						 <strong th:text='${comment.writer}'></strong>
	    						 <button th:if="${comment.writer} == ${#authentication.name}" class="btn btn-danger delete-comment" th:data-cno="${comment.cno}">ì‚­ì œ</button>
	    					</div>
	    					<div th:text='${comment.writeTime}'></div>
	    				</div>
	    				<div th:text='${comment.content}' class='lower'>
	    				</div>
	    				<hr>
	    			</div>
				</div>		
				
				<div class="d-flex justify-content-end mt-4" th:if="${result.writer == #authentication.name}">
					<a type="button" class="btn btn-info me-2" th:href="'/board/update?bno=' + ${result.bno}"> ë³€ê²½í•˜ê¸°</a>
					<a type="button" class="btn btn-danger" th:href="'/board/delete?bno=' + ${result.bno}"> ì‚­ì œí•˜ê¸°</a>
				</div>
			</section>
			<aside th:replace="~{/fragment/aside.html}"></aside>
		</main>
		<footer th:replace="~{/fragment/footer.html}"> </footer>
	</div>
	<script>
	// ëŒ“ê¸€ ì¶œë ¥ ë¦¬ìŠ¤íŠ¸
	function printComments(comments) {
		const $comments = $('#comments');
		const loginId = '[[${#authentication.name}]]';
		$comments.empty();
		console.log(comments);
		for(const c of comments) {
			const cno = c.cno;
			const deleteButtonHtml = c.writer === loginId ? `<button class="btn btn-danger delete-comment" data-cno="${cno}">ì‚­ì œ</button>` : '';
			const html = `
				<div >
				<div class='upper'style="display:flex; justify-content: space-between;">
					<div>
						<strong>${c.writer}</strong>
						${deleteButtonHtml}
					</div>
					<div>${c.writeTime}</div>
				</div>
				<div class='lower'>${c.content}</div>
				<hr>
			</div>				
			`;
			$comments.append($(html));
		}
	}
	</script>
	<script>
	//ëŒ“ê¸€ ì‘ì„±
	$('#write-comment').click(function() {
			const bno = '[[${result.bno}]]';
			const _csrf = '[[${_csrf.token}]]';
			const content = $('#comment').val();
			$.ajax({
				url: '/api/comments',
				method: 'post',
				data: {bno, content, _csrf},
				success(result) {
					printComments(result);
				}
			});
			$('#comment').val("");
		})
	</script>		
	<script>
	// ëŒ“ê¸€ ì‚­ì œ
		$('#comments').on('click', '.delete-comment', function() {
			const cno = $(this).data('cno');
			const bno = '[[${result.bno}]]';
			const _csrf = '[[${_csrf.token}]]';
			$.ajax({
				url: '/api/comments',
				method: 'delete',
				data: {bno, cno, _csrf},
				success(result) {
					console.log(result);
					printComments(result);
				}
			});
		});
	</script>
	<script>
	//ì¶”ì²œ ì¦ê°€
	$('#like-btn').click(function(){
		const _csrf = '[[${_csrf.token}]]';
		const bno = '[[${result.bno}]]';
		$.ajax({
			url:'/api/boards/good',
			method:'patch',
			data:  {bno, _csrf},
			success(result) {
				console.log(result);
				$('#goodCnt').text(result);
			}
		});
	});
	</script>	
</body>
</html>